#!/bin/bash
#
# This script will:
# * refresh - Update the current session look based on Xresources values.
# * stage - Copy Xresource and i3 config files in the user directory.
set -x

if [ "$#" -ne 1 ]; then
    echo "Usage: regolith-look <command>"
    echo "Commands: refresh, stage"
    exit 1
fi

COMMAND=$1

refresh() {
    # File Locations - Optional User Overrides
    USER_XRESOURCE_FILE="$HOME/.Xresources-regolith"

    # File Locations - System Defaults
    DEFAULT_XRESOURCE_FILE="/etc/regolith/styles/root"

    # Avoid loading an early version of the Regolith Xresource file
    BAD_XRES_HASH="6797c718fc4767653878ef9db5f68017"
    HASH=`md5sum $USER_XRESOURCE_FILE | cut -d " " -f1`
    if [ -f "$USER_XRESOURCE_FILE" -a "$HASH" != "$BAD_XRES_HASH" ]; then
        xrdb -merge $USER_XRESOURCE_FILE 
    else
        xrdb -merge $DEFAULT_XRESOURCE_FILE
    fi

    UPDATE_FLAG_DIR="$HOME/.config/regolith/flags"
    UI_REFRESH_FLAG_FILE="$UPDATE_FLAG_DIR/ui-fingerprint"
    KNOWN_FINGERPRINT=$(<$UI_REFRESH_FLAG_FILE)
    # Generate hash from Xresources that don't begin with 'X'.
    CURRENT_FINGERPRINT=$(xrdb -query | grep -v ^X | md5sum | cut -d' ' -f1)
    if [[ $KNOWN_FINGERPRINT != $CURRENT_FINGERPRINT ]]; then
        # Set the theme from Xresources values.
        gsettings set org.gnome.desktop.interface gtk-theme "`xrescat gnome.gtk.theme Adwaita`"
        gsettings set org.gnome.desktop.wm.preferences theme "`xrescat gnome.wm.theme Adwaita`"
        gsettings set org.gnome.desktop.interface icon-theme "`xrescat gnome.icon.theme Adwaita`"

        # Set the wallpaper
        WALLPAPER_FILE=$(xrescat gnome.wallpaper)
        if [[ ! -z $WALLPAPER_FILE ]]; then
                gsettings set org.gnome.desktop.background picture-uri $WALLPAPER_FILE
        fi

        # Save current fingerprint to avoid unnecessary configuration.
        echo $CURRENT_FINGERPRINT > $UI_REFRESH_FLAG_FILE

        # restart i3-wm after merging Xresources
        i3-msg restart
    fi
}

if [ "$COMMAND" == "refresh" ]; then
    refresh
elif [ "$COMMAND" == "stage" ]; then
    mkdir -p $HOME/.config/regolith/i3
    cp -b /etc/regolith/i3/config $HOME/.config/regolith/i3/
    cp -b /etc/regolith/styles/root $HOME/.Xresources-regolith

    echo "Files $HOME/.config/regolith/i3/config and $HOME/.Xresources-regolith have been created, log back in for them to take effect." 
else
    echo "Unrecognized command: $COMMAND"
    exit 1
fi
